name: CI

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
  pull_request:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'

jobs:
  cpp-build-test:
    name: C++ Build & Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        build-type: [Release]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
      
      - name: Install dependencies (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake build-essential
      
      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake
      
      - name: Setup MSVC (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1
      
      - name: Cache CMake build
        uses: actions/cache@v4
        with:
          path: build
          key: ${{ runner.os }}-cmake-${{ matrix.build-type }}-${{ hashFiles('**/CMakeLists.txt', '.gitmodules') }}
          restore-keys: |
            ${{ runner.os }}-cmake-${{ matrix.build-type }}-
            ${{ runner.os }}-cmake-
      
      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=${{ matrix.build-type }} -DBUILD_TESTING=ON -DBUILD_PYTHON_BINDINGS=OFF -DBUILD_WASM=OFF
      
      - name: Build C++
        run: |
          cmake --build build --config ${{ matrix.build-type }} -j 4
      
      - name: Run C++ tests
        run: |
          ctest --test-dir build --build-config ${{ matrix.build-type }} --output-on-failure
      
      - name: Upload test logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: cpp-test-logs-${{ matrix.os }}
          path: build/Testing/Temporary/LastTest.log
          retention-days: 7

  python-build-test:
    name: Python Build & Test (${{ matrix.os }}, cp313)
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    uses: ./.github/workflows/reusable-build-wheels.yml
    with:
      os: ${{ matrix.os }}
      cibw_build: 'cp313-*'

  wasm-build-test:
    name: WASM Build & Test
    uses: ./.github/workflows/reusable-build-wasm.yml
    with:
      upload_artifacts: false
